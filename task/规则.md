# Gnosis Pay PSE 集成架构文档

## 1. 核心架构

### 系统组件关系
```
前端应用 (Gnosis Pay UI)
    ↓ (HTTPS)
后端中继服务 (pse-backend-demo) - 本项目
    ↓ (mTLS)
Gnosis Pay PSE 私有API
    ↓
Secure Element (硬件安全模块)
```

### 三个核心文档之间的关系
- **Integration Model**: 定义了整个集成框架 - 包括参与方、通信方式、数据流
- **Auth**: 定义了认证方式 - mTLS(相互TLS)认证，使用证书和私钥
- **Onboarding Flow**: 定义了初始化流程 - 如何获取证书、启动服务

## 2. 认证机制

### mTLS (相互TLS) 认证
- **CLIENT_CERT**: 由Gnosis Pay签名的客户端证书（base64编码）
- **CLIENT_KEY**: 客户端私钥（base64编码）
- **流程**: 后端启动时加载证书，向PSE API请求时使用mTLS建立安全连接

### 当前实现
- 位置: `src/api/token/tokenController.ts`
- 方式: 使用Node.js https.Agent + axios库发起mTLS请求
- 端点: `POST ${GNOSIS_PSE_PRIVATE_API_BASE_URL}/api/v1/ephemeral-token`

## 3. 后端服务架构

### 主要路由
- `POST /token` - 获取ephemeral token（中继请求）
- `GET /health-check` - 服务健康检查
- `GET /native-webview` - Native Webview集成点

### 技术栈
- 框架: Express.js 5.1.0
- 语言: TypeScript 5.9.3
- 安全: helmet + CORS配置
- 日志: pino

### CORS配置
允许的源:
- `https://verified-pug-renewing.ngrok-free.app`
- `http://localhost`
- `https://app.gnosispay.com`
- `gp-ui.pages.dev` 通配符子域名

## 4. 环境变量配置

| 变量 | 说明 | 必需 |
|------|------|------|
| NODE_ENV | 运行环境 (development/production) | 是 |
| PORT | 服务端口 | 是 |
| HOST | 服务主机 | 是 |
| CLIENT_CERT | base64编码的客户端证书 | 原本是，现已移除认证 |
| CLIENT_KEY | base64编码的客户端私钥 | 原本是，现已移除认证 |
| GNOSIS_PSE_PRIVATE_API_BASE_URL | PSE API地址 | 是 |

## 5. 无认证体验模式

为了体验无需mTLS认证的集成方式，进行了以下修改：
1. 修改envConfig.ts - 使CLIENT_CERT和CLIENT_KEY可选
2. 修改tokenController.ts - 处理无认证情况，直接返回模拟响应或提示
3. 移除了mTLS Agent的强制验证

## 6. 集成流程

### 标准集成流程（有认证）
1. 获取由Gnosis Pay签名的证书和私钥
2. 配置环境变量 CLIENT_CERT 和 CLIENT_KEY
3. 启动后端服务
4. 前端调用 `/token` 端点请求ephemeral token
5. 后端使用mTLS连接PSE API获取token
6. 返回token给前端

### 演示集成流程（无认证）
1. 跳过获取证书步骤
2. 后端直接处理请求（不需要mTLS）
3. 可以返回模拟响应或测试数据
4. 用于体验基本集成流程

## 7. 关键注意事项

- CLIENT_CERT和CLIENT_KEY需要base64编码
- PSE API使用mTLS，普通HTTPS请求会被拒绝
- 后端需要信任PSE服务的证书（rejectUnauthorized: true）
- CORS配置限制了允许的源，本地开发使用localhost
